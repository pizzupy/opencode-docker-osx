#!/usr/bin/env python3
"""
Git Credential Helper for Docker Container

This helper runs inside the Docker container and communicates with the
host-side git-credential-proxy via Unix socket.

It implements the git credential helper protocol:
https://git-scm.com/docs/git-credential

Usage:
    git-credential-helper get
    git-credential-helper store
    git-credential-helper erase
"""

import sys
import socket
import os

# Socket path (mounted from host)
SOCKET_PATH = os.environ.get('GIT_CREDENTIAL_SOCK', '/tmp/git-credential-proxy.sock')

def communicate_with_proxy(operation, input_data):
    """
    Send credential request to proxy and return response
    
    Args:
        operation: The git credential operation (get/store/erase)
        input_data: Input data from git (key=value pairs)
    
    Returns:
        Response from proxy (for 'get' operation)
    """
    try:
        # Connect to Unix socket
        sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
        sock.connect(SOCKET_PATH)
        
        # Send operation and input data to proxy
        # Format: OPERATION\n<git credential protocol data>
        message = f"{operation}\n{input_data}"
        
        # Git credential protocol expects input terminated with blank line
        if not message.endswith('\n\n'):
            if message.endswith('\n'):
                message += '\n'
            else:
                message += '\n\n'
        
        sock.sendall(message.encode('utf-8'))
        
        # For 'get' operation, receive response
        if operation == 'get':
            response = b''
            while True:
                chunk = sock.recv(4096)
                if not chunk:
                    break
                response += chunk
                # Response ends with blank line
                if b'\n\n' in response or b'\r\n\r\n' in response:
                    break
            
            sock.close()
            return response.decode('utf-8')
        else:
            # For store/erase, no response expected
            sock.close()
            return ''
            
    except FileNotFoundError:
        print(f"Error: Socket not found at {SOCKET_PATH}", file=sys.stderr)
        print("Is the git-credential-proxy running on the host?", file=sys.stderr)
        sys.exit(1)
    except ConnectionRefusedError:
        print(f"Error: Could not connect to {SOCKET_PATH}", file=sys.stderr)
        print("Is the git-credential-proxy running on the host?", file=sys.stderr)
        sys.exit(1)
    except Exception as e:
        print(f"Error communicating with proxy: {e}", file=sys.stderr)
        sys.exit(1)


def main():
    if len(sys.argv) < 2:
        print("Usage: git-credential-helper <get|store|erase>", file=sys.stderr)
        sys.exit(1)
    
    operation = sys.argv[1]
    
    if operation not in ['get', 'store', 'erase']:
        print(f"Unknown operation: {operation}", file=sys.stderr)
        print("Valid operations: get, store, erase", file=sys.stderr)
        sys.exit(1)
    
    # Read input from stdin (git credential protocol)
    input_data = sys.stdin.read()
    
    # Communicate with proxy
    response = communicate_with_proxy(operation, input_data)
    
    # For 'get' operation, output the response
    if operation == 'get' and response:
        sys.stdout.write(response)
        sys.stdout.flush()


if __name__ == '__main__':
    main()
