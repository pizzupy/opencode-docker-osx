version: '3.8'

services:
  opencode-dev:
    image: opencode-dev:latest
    container_name: opencode-dev
    
    # Build configuration
    # Note: This uses a layered build approach:
    #   - Base layer (opencode-base): Ubuntu + tools (built separately, updates rarely)
    #   - OpenCode layer (opencode-dev): OpenCode + integrations (built frequently)
    # To build: ./build-all.sh (first time) or ./build-opencode.sh (updates)
    build:
      context: .
      dockerfile: Dockerfile
      args:
        OPENCODE_VERSION: latest
    
    # Keep container running
    stdin_open: true
    tty: true
    
    # Working directory
    working_dir: /workspace
    
    # Volume mounts
    volumes:
      # Mount current directory as workspace
      - .:/workspace
      
      # Mount git config (read-only)
      - ${HOME}/.gitconfig:/root/.gitconfig:ro
      
      # Mount SSH keys (read-only) for git operations
      - ${HOME}/.ssh:/root/.ssh:ro
      
      # Mount SSH agent socket for agent forwarding
      # On macOS with Docker Desktop, use the special /run/host-services path
      - /run/host-services/ssh-auth.sock:/ssh-agent
      
      # Optional: Mount git credential proxy socket for macOS Keychain access
      # Uncomment to enable (requires starting proxy: python3 lib/git-credential-proxy.py)
      # - /tmp/git-credential-proxy.sock:/tmp/git-credential-proxy.sock
      
      # Optional: Mount additional config directories
      # - ${HOME}/.config:/root/.config:ro
      
      # Optional: Persist shell history
      # Note: Named volumes work best with directories, not individual files
      # For bash/zsh, we create wrapper directories to hold the history files
      - opencode-bash-history:/root/.bash_history_volume
      - opencode-zsh-history:/root/.zsh_history_volume
      - opencode-fish-history:/root/.local/share/fish
    
    # Environment variables
    environment:
      - TERM=xterm-256color
      - COLORTERM=truecolor
      - SSH_AUTH_SOCK=/ssh-agent
      # - GIT_CREDENTIAL_SOCK=/tmp/git-credential-proxy.sock  # Uncomment if using git credential proxy
      
      # Optional: Pass through host environment variables
      # - GITHUB_TOKEN=${GITHUB_TOKEN}
      # - AWS_PROFILE=${AWS_PROFILE}
    
    # Network mode
    network_mode: bridge
    
    # Command to run (default shell)
    command: /bin/bash
    
    # Optional: Resource limits
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '2'
    #       memory: 4G
    #     reservations:
    #       cpus: '1'
    #       memory: 2G

# Named volumes for persistence
volumes:
  opencode-bash-history:
  opencode-zsh-history:
  opencode-fish-history:
